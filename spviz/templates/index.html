<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Fix me Correlation Matrix</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

    <script>

        function getSelectValues(select) {
            var result = [];
            var options = select && select.options;
            var opt;
        
            for (var i=0, iLen=options.length; i<iLen; i++) {
            opt = options[i];
        
            if (opt.selected) {
                result.push(opt.text);
            }
            }
            return result;
        }

        $(function() {
            // initialize 
            selectTypeValue = "pearson_corr";
            
            $('#open-file-btn').click(function() {
                var form_data = new FormData($('#open-file')[0]);
                var action = $('#open-file-btn').val();
                form_data.append('action', action);

                d3.select('#roleSelection').select("table").remove();
                var header;
                var file = document.querySelector('input[type=file]').files[0]; 
                if (file) {
                    var reader = new FileReader();
                    reader.onloadend = function(evt) {
                        var dataUrl = evt.target.result;

                        d3.csv( dataUrl, function( rows ) {
                            header = Object.keys(rows[0]);

                            $.ajax({
                                type: 'POST',
                                url: '/',
                                data: form_data,                                
                                contentType: false,
                                cache: false,
                                processData: false,
                                success: function(data) {
                                    var var_types = data.var_types;
                                    var samples = data.samples;
                                    roleTable(header, var_types, samples);

                                    // Avoid ctrl-click                                    
                                    $('option').mousedown(function(e) {
                                        e.preventDefault();
                                        var originalScrollTop = $(this).parent().scrollTop();
                                        $(this).prop('selected', $(this).prop('selected') ? false : true);
                                        var self = this;
                                        $(this).parent().focus();
                                        setTimeout(function() {
                                            $(self).parent().scrollTop(originalScrollTop);
                                        }, 0);
                                        
                                        return false;
                                    });                                    
                                },
                            });
                        })
                    };
                    reader.readAsDataURL(file);
                }                
            });

            $('#visualize-btn').click(function() {
                var form_data = new FormData($('#open-file')[0]);
                var action = $('#visualize-btn').val();

                form_data.append('action', action);

                var clusteringFlg = false;
                if($("input:checkbox:checked").prop("checked") == true){
                    clusteringFlg = true;
                }
                else{
                    clusteringFlg = false;
                }
                form_data.append('clustering', clusteringFlg);

                var table, tr, td, i;
                table = document.getElementById("roleTable");
                tr = table.getElementsByTagName("tr");

                var metaList = [];
                for(i = 1; i < tr.length; i++){
                    // name
                    var name_td = tr[i].getElementsByTagName("td")[0];
                    var nameValue = name_td.innerText;                    
                    // type
                    var type_td = tr[i].getElementsByTagName("td")[1];
                    var typeValue = type_td.getElementsByTagName("select")[0];
                    // role
                    var role_td = tr[i].getElementsByTagName("td")[2];
                    var roleValue = role_td.getElementsByTagName("select")[0];                 
                    // isCount
                    var isCount_td = tr[i].getElementsByTagName("td")[3];
                    var isCountValue = isCount_td.getElementsByTagName("select")[0];  

                    var singleObject =            
                                    {   
                                        name: nameValue,
                                        var_type: typeValue.options[typeValue.selectedIndex].value, 
                                        role: getSelectValues(roleValue),
                                        isCount: isCountValue.options[isCountValue.selectedIndex].value                                                                   
                                    };
  
                    metaList.push(singleObject);    
                }
                metaList = JSON.stringify(metaList);
                form_data.append('metaList', metaList);

                $.ajax({
                    type: 'POST',
                    url: '/',
                    data: form_data,
                    contentType: false,
                    cache: false,
                    processData: false,
                    success: function(data) {
                        
                    },
                });
                
            });
        });    
    </script>
</head>
<body class="center">
 <!--  <form id="upload-file" method="post" enctype="multipart/form-data">   -->
  <form id="open-file" action="/visualize" method="post"> 

    <div class= "row">
        <div id="extra">
            <br>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <input name="file" type="file" id="myFile" style = "width:170px">
            <button id="open-file-btn" type="button" value="open">Open</button>
            <input type="checkbox" id="clustering">&nbsp;<label style="font-size: 14px;">Clustering</label>
            <button id="visualize-btn" type="submit" value="visualize">Go Visualization</button>
            &nbsp;&nbsp;&nbsp;

        </div> 
        <div id="typeSelector">
            <br/>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        </div>
        <div id="roleSelection">
        </div>             
    </div>
    <script src="{{ url_for('static', filename='js/table.js') }}"></script>    
    </form>

</body>
