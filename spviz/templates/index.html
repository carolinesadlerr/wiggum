<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Correlation Matrix</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.min.js"></script>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

    <script>
        var divs = ["container", "tree", "scatterplot"];
        var visibleDivId = null;
        function toggleVisibility(divId) {
          //if(visibleDivId === divId) {
          //  visibleDivId = null;
          //} else {
          //  visibleDivId = divId;
          //}
          visibleDivId = divId;
          hideNonVisibleDivs();

          // always show table
          var tableDiv = document.getElementById("table"); 
          tableDiv.style.display = "inline-block";
        }
        function hideNonVisibleDivs() {
          var i, divId, div;
          var x = document.getElementById("scatterplot"); 

          for(i = 0; i < divs.length; i++) {
            divId = divs[i];
            div = document.getElementById(divId);

            if(visibleDivId === divId) {
              div.style.display = "block";
            } else {
              div.style.display = "none";
            }
            // Set for scatterplot
            if((x.id === divId) && (selectTypeValue == "Regression")) {
              x.style.display = "inline-block";
            } else {
              x.style.display = "none";
            }
          }
        }


        $(function() {
            var totalWeightChart = document.getElementById("totalweightchart");					
            var totalWeightProgress = new CircularProgress(totalWeightChart, 
                                    {fill: "#dd1c77", range:{min:0,max:100}, innerRadius: 15, outerRadius: 20});
            var totalWeightViewChart = document.getElementById("totalweightviewchart");					
            var totalWeightViewProgress = new CircularProgress(totalWeightViewChart, 
                                    {fill: "#dd1c77", range:{min:0,max:100}, innerRadius: 15, outerRadius: 20});                                    

            $('#upload-file-btn').click(function() {
                var form_data = new FormData($('#upload-file')[0]);
                var action = $('#upload-file-btn').val();
                form_data.append('action', action);
                var sp_type = $("#typeSelector option:selected").text();
                form_data.append('sptype', sp_type);

                // Sending weight parameters
                var weight_param = 
                    {   agg_trend: Number(document.getElementById("agg_trend_individual").value), 
                        all_slope: Number(document.getElementById("all_slope_individual").value),
                        angle: Number(document.getElementById("angle_individual").value), 
                        subgroup_slope: Number(document.getElementById("subgroup_slope_individual").value),  
                        subgroup_trend: Number(document.getElementById("subgroup_trend_individual").value)                                           
                    };
                weight_param = JSON.stringify(weight_param);
                form_data.append('weight_param', weight_param);

                // Sending weight parameters for view
                var weight_param_view = 
                    {   agg_trend: Number(document.getElementById("agg_trend_view").value), 
                        all_slope: Number(document.getElementById("all_slope_view").value),
                        angle_y: Number(document.getElementById("angle_view").value), 
                        subgroup_slope_y: Number(document.getElementById("subgroup_slope_view").value),  
                        subgroup_trend_y: Number(document.getElementById("subgroup_trend_view").value)                             
                    };
                weight_param_view = JSON.stringify(weight_param_view);
                form_data.append('weight_param_view', weight_param_view);    
                
                // Sending view score parameters
                var view_score_param = 
                    {   angle: document.getElementById("angle_selection").value, 
                        subgroup_slope: document.getElementById("subgroup_slope_selection").value,  
                        subgroup_trend: document.getElementById("subgroup_trend_selection").value                                            
                    };
                view_score_param = JSON.stringify(view_score_param);
                form_data.append('view_score_param', view_score_param);                  

                $.ajax({
                    type: 'POST',
                    url: '/',
                    data: form_data,
                    //data: {'form_data':form_data, 'action':action},
                    //data: {'action':action},
                    contentType: false,
                    cache: false,
                    processData: false,
                    success: function(data) {

                        var $categoricalVarsSelect = $('#categoricalVarsSelect');

                        for (var i = 0; i < data.length; i++) {
                            $categoricalVarsSelect.append('<option id=' + data[i] + ' value=' + data[i] + '>' + data[i] + '</option>');
                        }
                        // Get data from controller return data
                        drawGraph(data);

                        // Display info table
                        tableRecords = JSON.parse(data.table)
                        //d3.select("#table").style("display", "inline-block");                  

                        tableColumns = ['agg_trend', 'all_slope', 'angle_x', 'feat1', 'feat2', 'group_feat', 
                                'subgroup', 'subgroup_slope_x', 'subgroup_trend_x','std_wt',
                                'angle_y', 'subgroup_slope_y', 'subgroup_trend_y', 'std_wt_view'];
                        tabulate(tableRecords, tableColumns);

                        // Ranking
                        rankViewResult = JSON.parse(data.rankViewResult)
                        rankingView(rankViewResult);
                    },
                });
            });

            // Button Auto Detect
            $('#autodetect').click(function() {
                
                var action = $('#autodetect').val();
                var threshold = legendAdjustValue;
                var sp_type = $("#typeSelector option:selected").text();
                
                // Sending weight parameters
                var weight_param = 
                    {   agg_trend: Number(document.getElementById("agg_trend_individual").value), 
                        all_slope: Number(document.getElementById("all_slope_individual").value),
                        angle_x: Number(document.getElementById("angle_individual").value), 
                        subgroup_slope_x: Number(document.getElementById("subgroup_slope_individual").value),  
                        subgroup_trend_x: Number(document.getElementById("subgroup_trend_individual").value)                                            
                    };
                weight_param = JSON.stringify(weight_param);

                // Sending weight parameters for view
                var weight_param_view = 
                    {   agg_trend: Number(document.getElementById("agg_trend_view").value), 
                        all_slope: Number(document.getElementById("all_slope_view").value),
                        angle_y: Number(document.getElementById("angle_view").value), 
                        subgroup_slope_y: Number(document.getElementById("subgroup_slope_view").value),  
                        subgroup_trend_y: Number(document.getElementById("subgroup_trend_view").value),
                        SP_subgroups: Number(document.getElementById("sp_subgroups_view").value),
                        gby_counts: Number(document.getElementById("gby_counts_view").value),
                        portions: Number(document.getElementById("portions_view").value)                                                                    
                    };
                weight_param_view = JSON.stringify(weight_param_view);
                
                // Sending view score parameters
                var view_score_param = 
                    {   angle_x: document.getElementById("angle_selection").value, 
                        subgroup_slope_x: document.getElementById("subgroup_slope_selection").value,  
                        subgroup_trend_x: document.getElementById("subgroup_trend_selection").value                                            
                    };
                view_score_param = JSON.stringify(view_score_param);              

                $.ajax({
                    url: '/',
                    data: {'action' : action, 'threshold': threshold, 'sptype': sp_type, 'weight_param': weight_param, 
                            'weight_param_view': weight_param_view, 'view_score_param': view_score_param},     
                    type: 'POST',      
                    success: function(data) { 
                        // Get data from controller return data
                        autoDetectResult = JSON.parse(data.result)
                        autoDetectFlag = 1;
                        ranking = {};

                        if (selectTypeValue == "Regression") {
                            updateContainer();

                            // Display info table
                            tableRecords = JSON.parse(data.table)
                            console.log(tableRecords);
                            tableColumns = ['agg_trend', 'all_slope', 'angle_x', 'feat1', 'feat2', 'group_feat', 
                                'subgroup', 'subgroup_slope','subgroup_trend_x', 'SP_subgroups', 'gby_counts', 'portions', 'std_wt',
                                'angle_y', 'subgroup_trend_y', 'std_wt_view'];
                            tabulate(tableRecords, tableColumns);

                            // Ranking
                            rankViewResult = JSON.parse(data.rankViewResult)
                            rankingView(rankViewResult);

                        } else {
                            updateRateSPContainer();
                        }

                    }
                });
            });

            // number change
            $('input[type="number"]').change(function () {
                var str = $(this).attr("id");
                var sliderid = str.substring(0, str.length - 7);
                var value = $(this).val();
                $("#"+sliderid).val(value);

                // Total counting for individual
                var totalValue = 0;
                $("[id$='_individual_number']").each(function () { 
                    totalValue = totalValue + Math.round(this.value*100);
                });
                totalWeightProgress.update([totalValue]);

                // Total counting for view
                var totalValueView = 0;
                $("[id$='_view_number']").each(function () { 
                    totalValueView =  totalValueView + Math.round(this.value*100);
                });
                totalWeightViewProgress.update([totalValueView]);
            });       
        });    
    </script>
</head>
<body class="center">
<form id="upload-file" method="post" enctype="multipart/form-data"> 
   <!--  <form action="/" method="post" role="form">   -->

    <div class= "row">
        <div id="extra">
            <br>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

            <!--
            <input type="file" onchange="loadFile()" />
            -->
                {% with messages = get_flashed_messages() %}
                {% if messages %}
                    {% for message in messages %}
                        {{ message }}
                    {% endfor %}
                {% endif %}
                {% endwith %}
            <input name="file" type="file" style = "width:170px">
            <button id="upload-file-btn" type="button" value="upload">Upload</button>
            &nbsp;&nbsp;&nbsp;

            <a href="#" onclick="toggleVisibility('container')">Linear Layout</a>
            &nbsp;&nbsp;&nbsp;
            <div id="extra_regression" style="display:inline-block;" >
                <a href="#" onclick="toggleVisibility('tree')">Tree Hierarchy</a>
            </div>
            &nbsp;&nbsp;&nbsp;(Click a title to select a detail plot or a cell to focus a detail plot)       
        </div> 
        <div id="typeSelector">
            <br/>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        </div>
        <div id="selectors">
            <br/>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        </div>
        <div id ="slider" class="slider"></div>
        <br/><br/>
        <div id="legend"></div>
    </div>

           <!--
    <div style="display:inline-block;" id="categoricalVars">
        <select id="categoricalVarsSelect">
            <option id='all' value='all'>ALL</option>
        </select>
    </div>            -->
    <div id="rankingdiv">
        <table class="rankingparam" cellspacing="0" cellpadding="0">
            <tr>
                <td>
                    <table class="rankingparam" cellspacing="0" cellpadding="0">
                        <tr class = "paramtr">
                            <th class = "paramth" colspan="3">
                                Weight Setting for Individuals
                                <div id="totalweightchart"></div>
                            </th>
                        </tr>
                        <tr class = "paramtr">
                            <td class="param">agg_trend</td>
                            <td class="param">
                                <input type="range" class="paramslider" min="0" max="1" step="0.01" id="agg_trend_individual" value = "0" onchange="updateNumberInput(this.id, this.value);">
                            </td>                    
                            <td class="param">
                                <input type="number" id="agg_trend_individual_number" value="0" min="0" max="1" step="0.01" class="paramnumber"/>
                            </td>
                        </tr>
                        <tr class = "paramtr">
                            <td class="param">all_slope</td>
                            <td class="param">
                                <input type="range" class="paramslider" min="0" max="1" step="0.01" id="all_slope_individual" value = "0" onchange="updateNumberInput(this.id, this.value);">
                            </td>    
                            <td class="param">                       
                                <input type="number" id="all_slope_individual_number" value="0" min="0" max="1" step="0.01" class="paramnumber"/>
                            </td>
                        </tr>                    
                        <tr class = "paramtr">
                            <td class="param">angle</td>                 
                            <td class="param">                        
                                <input type="range" class="paramslider" min="0" max="1" step="0.01" id="angle_individual" value = "0" onchange="updateNumberInput(this.id, this.value);">
                            </td>                        
                            <td class="param">
                                <input type="number" id="angle_individual_number" value="0" min="0" max="1" step="0.01" class="paramnumber"/>
                            </td>
                        </tr>                    
                        <tr class = "paramtr">
                            <td class="param">subgroup_slope</td>                    
                            <td class="param">                        
                                <input type="range" class="paramslider" min="0" max="1" step="0.01" id="subgroup_slope_individual" value = "0" onchange="updateNumberInput(this.id, this.value);">
                            </td>
                            <td class="param">
                                <input type="number" id="subgroup_slope_individual_number" value="0" min="0" max="1" step="0.01" class="paramnumber"/>
                            </td>                    
                        </tr>                    
                        <tr class = "paramtr">
                            <td class="param">subgroup_trend</td>
                            <td class="param">                        
                                <input type="range" class="paramslider" min="0" max="1" step="0.01" id="subgroup_trend_individual" value = "0" onchange="updateNumberInput(this.id, this.value);">  
                            </td>    
                            <td class="param">
                                <input type="number" id="subgroup_trend_individual_number" value="0" min="0" max="1" step="0.01" class="paramnumber"/>
                            </td>                         
                        </tr>        
                    </table>
                </td>
                <td>
                    <table class="rankingparam" cellspacing="0" cellpadding="0">
                        <tr class = "paramtr">
                            <th class = "paramth" colspan="8">
                                Weight Setting for Views
                                <div id="totalweightviewchart"></div>
                            </th>
                        </tr>
                        <tr class = "paramtr">
                            <td class="param">agg_trend</td>
                            <td class="param"></td>
                            <td class="param">
                                <input type="range" class="paramslider" min="0" max="1" step="0.01" id="agg_trend_view" value = "0" onchange="updateNumberInput(this.id, this.value);">
                            </td>
                            <td class="param">
                                <input type="number" id="agg_trend_view_number" value="0" min="0" max="1" step="0.01" class="paramnumber"/>
                            </td>  
                            <td class="param">&nbsp;&nbsp;&nbsp;SP_subgroups</td>
                            <td class="param"></td>                            
                            <td class="param">                        
                                <input type="range" class="paramslider" min="0" max="1" step="0.01" id="sp_subgroups_view" value = "0" onchange="updateNumberInput(this.id, this.value);">  
                            </td>   
                            <td class="param">
                                <input type="number" id="sp_subgroups_view_number" value="0" min="0" max="1" step="0.01" class="paramnumber"/>
                            </td>                                                                                
                        </tr>
                        <tr class = "paramtr">
                            <td class="param">all_slope</td>
                            <td class="param"></td>                            
                            <td class="param">
                                <input type="range" class="paramslider" min="0" max="1" step="0.01" id="all_slope_view" value = "0" onchange="updateNumberInput(this.id, this.value);">
                            </td> 
                            <td class="param">
                                <input type="number" id="all_slope_view_number" value="0" min="0" max="1" step="0.01" class="paramnumber"/>
                            </td>    
                            <td class="param">&nbsp;&nbsp;&nbsp;gby_counts</td>
                            <td class="param"></td>                            
                            <td class="param">                        
                                <input type="range" class="paramslider" min="0" max="1" step="0.01" id="gby_counts_view" value = "0" onchange="updateNumberInput(this.id, this.value);">  
                            </td>  
                            <td class="param">
                                <input type="number" id="gby_counts_view_number" value="0" min="0" max="1" step="0.01" class="paramnumber"/>
                            </td>                                                 
                        </tr>                    
                        <tr class = "paramtr">
                            <td class="param">angle</td>
                            <td class="param">
                                <select id = "angle_selection" class="paramselection">
                                    <option value="sum">Sum</option>
                                    <option value="mean">Mean</option>
                                </select>
                            </td>                            
                            <td class="param">                        
                                <input type="range" class="paramslider" min="0" max="1" step="0.01" id="angle_view" value = "0" onchange="updateNumberInput(this.id, this.value);">
                            </td>
                            <td class="param">
                                <input type="number" id="angle_view_number" value="0" min="0" max="1" step="0.01" class="paramnumber"/>
                            </td>                               
                            <td class="param">&nbsp;&nbsp;&nbsp;portions</td>
                            <td class="param"></td>                            
                            <td class="param">                        
                                <input type="range" class="paramslider" min="0" max="1" step="0.01" id="portions_view" value = "0" onchange="updateNumberInput(this.id, this.value);">  
                            </td> 
                            <td class="param">
                                <input type="number" id="portions_view_number" value="0" min="0" max="1" step="0.01" class="paramnumber"/>
                            </td>                               
                        </tr>                    
                        <tr class = "paramtr">
                            <td class="param">subgroup_slope</td>
                            <td class="param">
                                <select id = "subgroup_slope_selection" class="paramselection">
                                    <option value="sum">Sum</option>
                                    <option value="mean">Mean</option>
                                </select>                                
                            </td>                            
                            <td class="param">                        
                                <input type="range" class="paramslider" min="0" max="1" step="0.01" id="subgroup_slope_view" value = "0" onchange="updateNumberInput(this.id, this.value);">
                            </td>
                            <td class="param">
                                <input type="number" id="subgroup_slope_view_number" value="0" min="0" max="1" step="0.01" class="paramnumber"/>
                            </td>
                            <td class="param"></td>
                            <td class="param"></td>
                            <td class="param" rowspan="2">
                                <button id="autodetect" type="button" name="autodetect" value="autodetect">AutoDetect</button> 
                            </td>                                                 
                        </tr>                    
                        <tr class = "paramtr">
                            <td class="param">subgroup_trend</td>
                            <td class="param">
                                <select id = "subgroup_trend_selection" class="paramselection">
                                    <option value="sum">Sum</option>
                                    <option value="mean">Mean</option>
                                </select>                                
                            </td>                           
                            <td class="param">                        
                                <input type="range" class="paramslider" min="0" max="1" step="0.01" id="subgroup_trend_view" value = "0" onchange="updateNumberInput(this.id, this.value);">  
                            </td>   
                            <td class="param">
                                <input type="number" id="subgroup_trend_view_number" value="0" min="0" max="1" step="0.01" class="paramnumber"/>
                            </td>                            
                        </tr>                                                        
                    </table>  
                </td>
                <td>
                    <table class="rankingparam" cellspacing="0" cellpadding="0">
                        <tr class = "paramtr">
                            <th class = "paramth" nowrap style="vertical-align: top;">
                                Ranked Views
                            </th>
                        </tr>
                        <tr class = "paramtr">
                            <td class="param" style="text-align: center;">                    
                                <select id ="ranking" size="10"></select>
                            </td>                         
                        </tr>                                                                                                                                    
                    </table>                      
            </td></tr>
        </table>    
    </div>
    <div style="display:none; float:left" id="container">
    </div>

    <div style="display:none; float:left" id="tree"></div>
    <div style="display:none; float:left" id="table"></div>
               <!--<div class="vl"></div>  -->
    <div id="slopeLabel"></div>
    <div style="display:none; float:left" id="scatterplot"></div>
    <div id="slopegraph"></div>
    <div id="groupedbarchart"></div>

    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script src="{{ url_for('static', filename='js/newmain.js') }}"></script>

    <script src="{{ url_for('static', filename='js/tree.js') }}"></script>
    <script src="{{ url_for('static', filename='js/scatterplot.js') }}"></script>
    <script src="{{ url_for('static', filename='js/correlationMatrix.js') }}"></script>
    <script src="{{ url_for('static', filename='js/rateMatrix.js') }}"></script>
    <script> d3.eesur = {}; </script>
    <script src="{{ url_for('static', filename='js/d3_code_slopegraph.js') }}"></script>
    <script src="{{ url_for('static', filename='js/slopegraph.js') }}"></script>
    <script src="{{ url_for('static', filename='js/groupedbarchart.js') }}"></script>
    <script src="{{ url_for('static', filename='js/table.js') }}"></script>
    <script src="{{ url_for('static', filename='js/rankingView.js') }}"></script>    
    <script src="{{ url_for('static', filename='js/circularProcess.js') }}"></script>        
    </form>

</body>
